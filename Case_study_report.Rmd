---
title: 'Case Study : BikeTrips'
author: "Jyotisman"
date: "6/9/2021"
output: html_document
---

## Import and Load libraries
Let's start by installing the tidyverse package. We also have to load the lubridate package separately as it does not automatically gets loaded with tidyverse.

```{r echo = FALSE}
install.packages("tidyverse", repos = "http://cran.us.r-project.org")
library(tidyverse)
library(lubridate)
```


## Collect Data

The business task entails exploring how different customer types are using Cyclistic bikes and for that we will use Cyclistic's historical trip data to analyze and identify trends. We will use 12 months of data starting from the 2nd quarter of 2019 to the first quarter of 2020.

The relevant data was obtained from [here](https://divvy-tripdata.s3.amazonaws.com/index.html) and stored locally. It has been made available by Motivate International Inc. under this [license](https://www.divvybikes.com/data-license-agreement).
```{r message = FALSE}
q2_2019 <- read_csv("bike_trips_data/Divvy_Trips_2019_Q2/Divvy_Trips_2019_Q2.csv")
q3_2019 <- read_csv("bike_trips_data/Divvy_Trips_2019_Q3/Divvy_Trips_2019_Q3.csv")
q4_2019 <- read_csv("bike_trips_data/Divvy_Trips_2019_Q4/Divvy_Trips_2019_Q4.csv")
q1_2020 <- read_csv("bike_trips_data/Divvy_Trips_2020_Q1/Divvy_Trips_2020_Q1.csv")
```
We will be joining them eventually but lets make sure they share the same column names even if not in the same order.
```{r}
colnames(q2_2019)
```
```{r}
colnames(q3_2019)
```
```{r}
colnames(q4_2019)
```
```{r}
colnames(q1_2020)
```
Given that 'q1_2020' is the most recent, we will follow its column specifications throughout. Let's fix the columns for the others accordingly.


## Data Cleaning

To begin with, we will rename the columns of all the 2019 data to match with the 2020 one.
```{r}
q4_2019 <- rename(q4_2019,
                  ride_id = trip_id,
                  rideable_type = bikeid,
                  started_at = start_time,
                  ended_at = end_time,
                  start_station_id = from_station_id,
                  start_station_name = from_station_name,
                  end_station_name = to_station_name,
                  end_station_id = to_station_id,
                  member_casual = usertype)
```

```{r}
q3_2019 <- rename(q3_2019,
                  ride_id = trip_id,
                  rideable_type = bikeid,
                  started_at = start_time,
                  ended_at = end_time,
                  start_station_id = from_station_id,
                  start_station_name = from_station_name,
                  end_station_name = to_station_name,
                  end_station_id = to_station_id,
                  member_casual = usertype)
```

```{r}
q2_2019 <- rename(q2_2019,
                  ride_id = "01 - Rental Details Rental ID",
                  rideable_type = "01 - Rental Details Bike ID",
                  started_at = "01 - Rental Details Local Start Time",
                  ended_at = "01 - Rental Details Local End Time",
                  start_station_id = "03 - Rental Start Station ID",
                  start_station_name = "03 - Rental Start Station Name",
                  end_station_name = "02 - Rental End Station Name",
                  end_station_id = "02 - Rental End Station ID",
                  member_casual = "User Type")
```
Let's check their structure now just to make sure everything is right till this point.
```{r}
str(q4_2019)
```
```{r}
str(q2_2019)
```
```{r}
str(q3_2019)
```
```{r}
str(q1_2020)
```

To match with the data type of q1_2020, we will convert the data type of columns ride_id and rideable_type to character in the 2019 data.
```{r}
q4_2019 <-  mutate(q4_2019, ride_id = as.character(ride_id),
                   rideable_type = as.character(rideable_type)) 
q3_2019 <-  mutate(q3_2019, ride_id = as.character(ride_id),
                   rideable_type = as.character(rideable_type)) 
q2_2019 <-  mutate(q2_2019, ride_id = as.character(ride_id),
                   rideable_type = as.character(rideable_type)) 
```
Now we can finally combine the different quarters into a single dataframe that will now contain the bike trips data for an entire year.
```{r}
all_trips <- bind_rows(q2_2019, q3_2019, q4_2019, q1_2020)
```
```{r}
head(all_trips)
```
We do not need all the columns, so let's remove some of the them especially the ones that do not exist anymore in the 2020 data.
```{r}
all_trips <- all_trips %>%  
  select(-c(start_lat, start_lng, end_lat, end_lng, birthyear, gender, "01 - Rental Details Duration In Seconds Uncapped", "05 - Member Details Member Birthday Year", "Member Gender", "tripduration"))
```
```{r}
head(all_trips)
```
```{r}
colnames(all_trips)
```
```{r}
nrow(all_trips)
```
```{r}
str(all_trips)
```
```{r}
summary(all_trips)
```
Let's view the only null value in the data frame that shows up in the summary. 
```{r}
all_trips[!complete.cases(all_trips),]
```
It belongs to one of the categories of observations that we are going to remove from our data frame later on. So, we can ignore this for the time being. 
```{r}
unique(all_trips$member_casual)
```
We have four different values but in reality there are only unique values. This happens because Divvy used to call 'member' and 'casual' as 'subscriber' and 'Customer' respectively prior to 2020. So, lets fix this.
```{r}
all_trips <-  all_trips %>% 
  mutate(member_casual = recode(member_casual,
                           "Subscriber" = "member",
                           "Customer" = "casual"))
```
Let's make sure it is fixed.
```{r}
unique(all_trips$member_casual)
```
Since we are interested in trends over months, days or days of the week, its good to create separate columns for each of them.
```{r}
all_trips$date <- as.Date(all_trips$started_at) #The default format is yyyy-mm-dd
all_trips$month <- format(as.Date(all_trips$date), "%m")
all_trips$day <- format(as.Date(all_trips$date), "%d")
all_trips$year <- format(as.Date(all_trips$date), "%Y")
all_trips$day_of_week <- format(as.Date(all_trips$date), "%A")
all_trips$hour_of_day <- format(all_trips$started_at, "%H")
```
```{r}
head(all_trips)
```
Now, we will create a column to measure the tripduration of each ride. We deleted the tripduration column from before since the 2020 data did not have such a column. So we can now create such a calculated column for the entire dataframe.

```{r}
all_trips$ride_length <- as.numeric(difftime(all_trips$ended_at,all_trips$started_at))
```
Make sure it is numeric.
```{r}
is.numeric(all_trips$ride_length)
```
Now we are going to remove data that either correspond to the station name being "HQ QR" or for which ride_length < 0 (which is unphysical). The "HQ QR" corresponds to entries where bikes were taken out of docks and checked for quality by Divvy.
```{r}
all_trips_v2 <- all_trips[!(all_trips$start_station_name == "HQ QR" | all_trips$ride_length<0),]
```
## Descriptive Analysis
Let's find some general statistical descriptions of the ride_length variable.
```{r}
summary(all_trips_v2$ride_length)
```
First, let's compare the summary statistics by member type.
```{r}
all_trips_v2 %>% 
  group_by(member_casual) %>% 
  summarise(mean_rl = mean(ride_length), median_rl = median(ride_length), max_rl = max(ride_length), min_rl = min(ride_length))
```
This clearly brings out one clear difference between casual and member riders. Casual riders use the bikes for a much longer duration on average. This could become an important consideration for accomplishing the task at hand which is to convert casual riders into annual ones.  
Let's now throw in the day of the week into the aggregation as well and only look at the mean rides.  
```{r}
all_trips_v2 %>% 
  group_by(day_of_week, member_casual) %>% 
  summarise(mean_rl = mean(ride_length))
```
Or the same can be done with the aggregate function as follows---
```{r}
aggregate(all_trips_v2$ride_length ~ all_trips_v2$member_casual + all_trips_v2$day_of_week, FUN = mean)
```

```{r}
# analyze ridership data by type and weekday
counts_day_of_week <- all_trips_v2 %>% 
  mutate(weekday = wday(started_at, label = TRUE)) %>%  #creates weekday field using wday()
  group_by(member_casual, weekday) %>%  #groups by usertype and weekday
  summarise(number_of_rides = n(),							#calculates the number of rides and average duration 
  average_duration = mean(ride_length)) %>% 		# calculates the average duration
  arrange(member_casual, weekday)								# sorts
```
```{r}
head(counts_day_of_week)
```
```{r}
write.csv(counts_day_of_week, file = "bike_trips_data/avg_count_ride_length_wday.csv")
```
```{r}
# analyze ridership data by type and month
counts_month <- all_trips_v2 %>% 
  group_by(member_casual, month) %>%  #groups by usertype and weekday
  summarise(number_of_rides = n(),							#calculates the number of rides and average duration 
  average_duration = mean(ride_length)) %>% 		# calculates the average duration
  arrange(member_casual, month)								# sorts
```
```{r}
head(counts_month)
```
```{r}
write.csv(counts_month, file = "bike_trips_data/avg_count_ride_length_month.csv")
```
## Visualizing our analysis
First, let's visulaize the number of rides per user type on different days of the week.
```{r}
all_trips_v2 %>% 
  mutate(weekday = wday(started_at, label = TRUE)) %>% 
  group_by(member_casual, weekday) %>% 
  summarise(number_of_rides = n()
            ,average_duration = mean(ride_length)) %>% 
  arrange(member_casual, weekday)  %>% 
  ggplot(aes(x = weekday, y = number_of_rides, fill = member_casual)) +
  geom_col(position = "dodge")
```

The annual members clearly do more rides than casual riders for any day of the week. The trend over the weeks is also kind of different for the 2 rider types. While the surge in casual riders happen during the weekends, the annual members use the service more often during the weekdays.  
Next, let's do the same but with mean duration of rides. 
```{r}
# Let's create a visualization for average duration
all_trips_v2 %>% 
  mutate(weekday = wday(started_at, label = TRUE)) %>% 
  group_by(member_casual, weekday) %>% 
  summarise(number_of_rides = n()
            ,average_duration = mean(ride_length)) %>% 
  arrange(member_casual, weekday)  %>% 
  ggplot(aes(x = weekday, y = average_duration, fill = member_casual)) +
  geom_col(position = "dodge")
```

The mean duration is significantly higher for the casual riders for any day of the week.How about the trend across months in a year? Let's see that now. 
```{r}
all_trips_v2 %>% 
  group_by(member_casual, month) %>% 
  summarise(number_of_rides = n()
            ,average_duration = mean(ride_length)) %>% 
  arrange(member_casual, month)  %>% 
  ggplot(aes(x = month, y = number_of_rides, fill = member_casual)) +
  geom_col(position = "dodge")
```

Not much difference in the trends for the two groups. A normal curve for both groups with peaks around July-August.  
Let's now explore one more layer of granularity, the hours of a day. Let's divide the analysis into weekdays and weekends. 

### Weekdays

```{r}
# For weekdays ----
all_trips_v2 %>% 
  filter(!day_of_week %in% c("Saturday", "Sunday")) %>% 
  group_by(member_casual, hour_of_day) %>% 
  summarise(avg_number_of_rides = n()/5
            ,average_duration = mean(ride_length)) %>% 
  arrange(member_casual, hour_of_day)  %>% 
  ggplot(aes(x = hour_of_day, y = avg_number_of_rides, fill = member_casual)) +
  geom_col(position = "dodge")
```

Two peaks for annual members, one in the morning hours and the other in in the evening around 4-5pm. Casual riders have a significantly lower outing with riders gradually peaking in the evening around 4-5pm.

### Weekends

```{r}
# For weekends----- 
all_trips_v2 %>% 
  filter(day_of_week %in% c("Saturday", "Sunday")) %>% 
  group_by(member_casual, hour_of_day) %>% 
  summarise(avg_number_of_rides = n()/2
            ,average_duration = mean(ride_length)) %>% 
  arrange(member_casual, hour_of_day)  %>% 
  ggplot(aes(x = hour_of_day, y = avg_number_of_rides, fill = member_casual)) +
  geom_col(position = "dodge")
```

The trend here is similar for both groups. There is a slight increase of the casual riders in weekends and the number of annual members have fallen down significantly from the weekdays while still leading the casual riders in the number of rides. 

The aggregated data have been written to csv files and can be used for further analysis.

